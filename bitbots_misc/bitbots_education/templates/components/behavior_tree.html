{% macro behavior_tree_component() %}

<script type="text/javascript">
  function render_tree(tree, reason){
    if (tree.children !== undefined)
    {
        let string = `<li><code class="bg-sky-800 text-white">${behavior_translate(reason)} --> <br> ${behavior_translate(tree.name)}</code>
            <ul>`;
        for (let key in tree.children)
        {
            string += render_tree(tree.children[key], key);
        }
        return string + `</ul>
            </li>`;
    }
    else
    {
        if (tree.type === "action")
        {
            return `<li><code class= "bg-zinc-100">${behavior_translate(reason)} --> <br> ${behavior_translate(tree.name)}</code></li>`;
        }
        else if (tree.type ==="sequence")
        {
            function make_sequence(sequence, first, reason)
            {
                const action = sequence.shift();
                if (first)
                {
                  return `<li><code class= "bg-zinc-100">${behavior_translate(reason)} --> <br> ${behavior_translate(action.name)}</code><ul>${make_sequence(sequence,false)}</ul></li>`;
                }
                else if (sequence.length > 1)
                {
                    return `<li><code class="bg-zinc-100">${behavior_translate(action.name)}</code><ul>${make_sequence(sequence,false)}</ul></li>`;
                }
                else
                {
                    return `<li><code class = "bg-zinc-100">${behavior_translate(action.name)}</code></li>`;
                }
            }
            return make_sequence(tree.action_elements, true, reason);
        }
    }
  }

  function behavior_tree_state() {
    return {
      listener: null,
      init() {
        this.listener = new ROSLIB.Topic({
          ros : ros,
          name : '/debug/dsd/body_behavior/dsd_tree',
          messageType : 'std_msgs/msg/String'
        });
        this.listener.subscribe((message) => {
          const behavior_tree = JSON.parse(message.data);
          let output_string = render_tree(behavior_tree, "START");
          this.$refs.tree.innerHTML = output_string;
        });
      },
      destroy() {
        this.listener.unsubscribe();
      },
    };
  }
</script>

<style>
  body {
    overflow-x: hidden;
  }

  /* It's supposed to look like a tree diagram */
  .tree, .tree ul, .tree li {
      list-style: none;
      margin: 0;
      padding: 0;
      position: relative;
  }
  .tree-container {
    overflow-x: auto; /* enables horizontal scrolling */
    max-width: 100%;
    -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
    white-space: nowrap; 
    text-align: center;
  }
  .tree {
      margin: 0 0 1em;
      display: inline-block;
      min-width: 600px;
  }
  .tree ul {
    display: flex;
    justify-content: center; 
    width: 100%;
    padding: 0;
  }
    .tree li {
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    position: relative;
    padding: .5em;
  }
  /* _________ */
  .tree li:before {
  outline: solid 1px #666;
  content: "";
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
  }
  .tree li:first-child:before {left: 50%;}
  .tree li:last-child:before {right: 50%;}

  .tree code, .tree span {
  border: solid .1em #666;
  border-radius: .2em;
  display: inline-block;
  margin: 0 .2em .5em;
  padding: .2em .5em;
  position: relative;
  }
  /* If the tree represents DOM structure */
  .tree code {
  font-family: monaco, Consolas, 'Lucida Console', monospace;
  }

  /* | */
  .tree ul:before,
  .tree code:before,
  .tree span:before {
      outline: solid 1px #666;
      content: "";
      height: .5em;
      left: 50%;
      position: absolute;
  }
  .tree ul:before {
      top: -.5em;
  }
  .tree code:before,
  .tree span:before {
      top: -.55em;
  }

  /* The root node doesn't connect upwards */
  .tree > li {margin-top: 0;}

  .tree > li:before,
  .tree > li:after,
  .tree > li > code:before,
  .tree > li > span:before {
    outline: none;
  }
  
</style>

<div x-data="behavior_tree_state()" class=" pt-2 w-100 bg-sky-100">
  <div class="tree-container">
    <ul class="tree bg-sky-100" x-ref="tree"></ul>
  </div>
</div>

{% endmacro %}
